<!DOCTYPE html>
<html>
<head>
    <title>Home.Ekus</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link href="css/bootstrap-metro.css" rel="stylesheet">-->
    <link href="less/bootstrap.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <link href="css/flatWeatherPlugin.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <!--<link href="css/bootstrap-theme.min.css" rel="stylesheet">-->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="scripts/jquery-2.1.1.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="scripts/jquery.signalR-2.1.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script src="scripts/angular.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="scripts/bootstrap.min.js"></script>
    <!--<script src="scripts/diff_match_patch.js"></script> see http://www.dotnetcurry.com/showarticle.aspx?ID=903 for implementation of realtime text editing -->
    <script type="text/javascript">

    // Define a new module for our app. The array holds the names of dependencies if any.
        var app = angular.module("dashboard", []);


    // The controller
    function dashboardController($scope, $http, $interval){



    // The data model. These items would normally be requested via AJAX,
    // but are hardcoded here for simplicity. See the next example for
    // tips on using AJAX.

        $scope.items = [
            { title:"ON", code:"FF02FD" },
            { title:"OFF", code:"FF02FD" },
            { title: "amber", code: "FF2AD5", color: "#FFC200" },
            { title: "red", code: "FF1AE5", color: "#FA0000" },
            { title: "green", code: "FF9A65", color: "#00C000" },
            { title: "lilac", code: "FF58A7", color: "#FF40FF" },
            { code: "FFAA55", color: "#00FFFF"},
            { title:"fade", code:"FF609F" },
            { title:"lighter", code:"FF3AC5" },
            { title: "darker", code: "FFBA45" },
            { title:"flash", code:"FFD02F" }
        ];

        $scope.color = function (item, $window) {
          //  setTimeout(function () {
                $scope.chatHub.server.send($('#displayname').val(), "N " + item.code);
           // }, 1);

        };

        $scope.messages = [];
        $scope.shoppingList = [];
        $scope.newShoppingListItem = { Text: '' };
        $scope.counter = 0;
        $scope.ajaxCounter = 0;
        // Declare a proxy to reference the hub.
        $scope.chatHub = $.connection.chatHub;

        //track connection state for troubleshooting. we could've probably observed $.connection.hub.state instead, but we'd still have to convert it to text using similar code.
        $scope.connectionState = "initializing...";
        $.connection.hub.stateChanged(function (change) {
            $scope.$apply(function() {
                //0: 'connecting', 1: 'connected', 2: 'reconnecting', 4: 'disconnected'
                if (change.newState === $.signalR.connectionState.reconnecting) $scope.connectionState= "reconnecting";
                else if (change.newState === $.signalR.connectionState.connected) {
                    $scope.connectionState = "connected";
                    $scope.getData();
                }
                else if (change.newState === $.signalR.connectionState.disconnected) {
                    $scope.connectionState = "disconnected";
                    window.setTimeout(function () {
                        $.connection.hub.start();
                    }, 1000); //
                }
                else if (change.newState === $.signalR.connectionState.connecting) $scope.connectionState = "connecting";
                else $scope.connectionState = "unknown";
            })
        });



        // Create a function that the hub can call to broadcast messages.
        $scope.chatHub.client.broadcastMessage = function (chatMsg) {
            $scope.$apply(function () {
                if ($scope.messages.length > 200) $scope.messages.splice(0, $scope.messages.length - 200); //remove oldest items that are beyond our limit
                $scope.messages.push(chatMsg);
            });
        };

        $scope.chatHub.client.trace = function (message) {
            var encodedMsg = $('<div />').text(message).html();
            // Add the message to the page.
            $('#discussion').append('<li><i>' + encodedMsg + '</i></li>');
        }

        $scope.listHub = $.connection.listHub;

        // invoked by server when the model changes. we update each ListItem separately.
        $scope.listHub.client.broadcastItem = function (item) {
            $scope.$apply(function () {
                var handled = false;
                for (var i = 0; i < $scope.shoppingList.length; i++) {
                    if ($scope.shoppingList[i].Id == item.Id) {
                        // do NOT update if the version received is older than our current one (due to latency, race conditions..).
                        if (new Date($scope.shoppingList[i].Timestamp) < new Date(item.Timestamp)) {
                            // update the item to follow server state
                            $scope.shoppingList[i] = item;
                        }
                        handled = true; //treat as handled even if we discarded the obsolete version (we don't want to have it added as new item, either!)
                        break;
                    }
                }
                // else add new item
                if (!handled) {
                    $scope.shoppingList.push(item);
                   // $scope.registerWatcherForItem($scope.shoppingList.length - 1);
                }

            });
        };

        $scope.getData = function () {
            $scope.ajaxCounter++;
            $scope.chatHub.server.getMessages()
               .done(function (msgs) { $scope.$apply(function () { $scope.ajaxCounter--; $scope.messages = msgs; }) })
               .fail(function (error) {$scope.$apply(function () { $scope.ajaxCounter--; alert('Error: ' + error);}) });

            $scope.ajaxCounter++;
            $scope.listHub.server.getItems()
               .done(function (items) { $scope.$apply(function () { $scope.ajaxCounter--; $scope.shoppingList = items; }) })
               .fail(function (error) { $scope.$apply(function () { $scope.ajaxCounter--; alert('Error: ' + error);}) });
        };

        $scope.listHub.client.trace = $scope.chatHub.client.trace;

        // Start the connection.
        $.connection.hub.start().done(function () {
            $('#sendmessage').click(function () {
                // Call the Send method on the hub.
                $scope.chatHub.server.send($('#displayname').val(), $('#message').val());
                // Clear text box and reset focus for next comment.
                $('#message').val('').focus();
            });

            $scope.getData();

            $scope.addShopListItem = function () {
                $scope.listHub.server.addItem($scope.newShoppingListItem.Text);
                $scope.newShoppingListItem = {};
            }

        });

        $scope.shopListItemToUpdate = null;

        //$scope.registerWatcherForItem = function (index) {
        //    // the first watcher is used to identify the affected item. we could use just a single deep watcher but that would actually be more difficult.
        //    // we may reconsider switching to single watcher though... and/or adding code that finds what changed and in which item to the server (hub)
        //    $scope.$watch('shoppingList[' + index + ']', function (newValue, oldValue) {
        //        if (newValue !== undefined) $scope.shopListItemToUpdate = newValue.Id;
        //        $scope.counter = $scope.counter + 1;
        //        console.log(newValue);
        //    }, true);

        //    $scope.$watch('shoppingList[' + index + '].IsUrgent', function (newValue, oldValue) {
        //        $scope.counter = $scope.counter + 1;
        //        console.log(newValue);
        //        $scope.listHub.server.setUrgent($scope.shopListItemToUpdate, newValue);
        //    });

        //    $scope.$watch('shoppingList[' + index + '].Text', function (newValue, oldValue) {
        //        $scope.counter = $scope.counter + 1;
        //        console.log(newValue);
        //        $scope.listHub.server.updateText($scope.shopListItemToUpdate, newValue);
        //    });

        //}


        // Get the user name and store it to prepend to messages.
        $('#displayname').val("User" + Math.round(1000 * Math.random()));

        $('#message').keydown(function (event) {
            var keypressed = event.keyCode || event.which;
            if (keypressed == 13) {
                $("#sendmessage").click();
            }
        });

        // Set initial focus to message input box.
        $('#message').focus();

        $scope.clickTV = function () {
            // Call the Send method on the hub.
            $scope.chatHub.server.send($('#displayname').val(), "G");
            //// Clear text box and reset focus for next comment.
            //$('#message').val('').focus();


        }

        $scope.veraSwitch = function (deviceId, onOff) {
            console.log(onOff);
            console.log(onOff ? 1 : 0);
            $scope.veraSend('data_request?id=action&output_format=xml&DeviceNum=' + deviceId + '&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=' + (onOff ? 1 : 0));
        }

        $scope.veraSend = function (url) {
            var veraBaseUrl = 'http://192.168.1.75/';

            $http.get(veraBaseUrl + url).
              success(function (data, status, headers, config) {
                  $scope.veraSendMessage = data;
                  // this callback will be called asynchronously
                  // when the response is available
                  $scope.veraRefreshDevices();
              }).
              error(function (data, status, headers, config) {
                  $scope.veraSendMessage = data;
                  // called asynchronously if an error occurs
                  // or server returns response with an error status.
                  $scope.veraRefreshDevices();
              });
        }

        $scope.veraRefreshDevices = function () {
            console.log("veraRefreshDevices calling...");
            var veraBaseUrl = 'http://192.168.1.75/';
            $http.get(veraBaseUrl + "data_request?id=lu_sdata")
              .success(function (data, status, headers, config) {
                  $scope.devices = data.devices;
                  //console.log("veraRefreshDevices finished.");
                  // this callback will be called asynchronously
                  // when the response is available
              })
                .error(function (data, status, headers, config) {
                    $scope.veraSendMessage = data;
                    //console.log("veraRefreshDevices finished with error.");
                    // called asynchronously if an error occurs
                    // or server returns response with an error status.
                });
        }

        $interval($scope.veraRefreshDevices, 1500); //todo: consider migrating to signalR instead of short polling.


    }
    </script>


</head>

<body ng-app="dashboard" ng-controller="dashboardController">
    <div class="container">
        <!--<div class="navbar navbar-inverse  no-padding">
            <div class="container ">
                <button class="navbar-toggle pull-left" data-toggle="collapse" data-target=".navHeaderCollapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="#" class="navbar-brand">Wall Panel </a>

            </div>
        </div>-->

        <div class="row">
      

            <!-- vertical menu for tablets+ -->
            <div class="col-sm-1 hidden-xs no-padding " >
                <!--width:50px;-->

                <ul class="side-menu pull-right">
                    <li class="side-menu-item"><a href="#home"><i class="fa fa-home"></i></a></li>
                    <li class="side-menu-item active"><a href="#lights"><i class="fa fa-lightbulb-o"></i></a></li>
                    <li class="side-menu-item"><a href="#music"><i class="fa fa-music"></i></a></li>
                    <li class="side-menu-item"><a href="#messages"><i class="fa fa-comment-o"></i></a></li>
                    <li class="side-menu-item"><a href="#shopList"><i class="fa fa-shopping-cart"></i></a></li>
                    <li class="side-menu-item"><a href="#settings"><i class="fa fa-cog"></i></a></li>
                </ul>
            </div>

            <!-- horizontal menu for mobiles -->

            <div class="col-xs-11
                  hidden-sm
                 hidden-md
                 hidden-lg
                  no-padding " _style="color:black;background-color:aqua;font-size:24px"><!--width:50px;-->

                <ul class="side-menu">
                    <li class="side-menu-item"         style="display:inline-block;min-width:50px;margin:0"><a href="#home"><i class="fa fa-home"></i>           &nbsp;</a></li>
                    <li class="side-menu-item active"  style="display:block;float:left;width:50px;margin:0"><a href="#lights"><i class="fa fa-lightbulb-o"></i>  &nbsp;</a></li>
                    <li class="side-menu-item"         style="display:block;float:left;width:50px;margin:0"><a href="#music"><i class="fa fa-music"></i>         &nbsp;</a></li>
                    <li class="side-menu-item"         style="display:block;float:left;width:50px;margin:0"><a href="#messages"><i class="fa fa-comment-o"></i></a></li>
                    <li class="side-menu-item"         style="display:block;float:left;width:50px;margin:0"><a href="#shopList"><i class="fa fa-shopping-cart"></i></a></li>
                    <li class="side-menu-item"         style="display:block;float:left;width:50px;margin:0"><a href="#settings"><i class="fa fa-cog"></i></a></li>
                </ul>
            </div>

            <div class="col-xs-11 bg-gray-dark">
                <h4>Connection: {{connectionState}}   <span ng-show="ajaxCounter">(updating...)</span></h4>
                <!-- Tab panes -->
                <div class="tab-content" style="min-height:1000px;">
                    <div class="tab-pane" id="home">
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="panel panel-default">
                                    <div class="panel-heading">Weather in Cary</div>
                                    <div class="panel-body">
                                        <div id="example">
                                            <div class="flatWeatherPlugin partial">
                                                <h2>Cary</h2><div class="wiToday">
                                                    <div class="wiIconGroup">
                                                        <div class="wi wi500"></div>
                                                        <p class="wiText">Light rain</p>
                                                    </div><p class="wiTemperature">62<sup>°F</sup></p><p class="wiDay">Tuesday</p>
                                                </div>
                                                <ul class="wiForecasts">
                                                    <li class="wiDay">
                                                        <span>Wednesday</span>
                                                        <ul class="wiForecast">
                                                            <li class="wi wi501"></li>
                                                            <li class="wiMax">58<sup>°F</sup></li>
                                                            <li class="wiMin">55<sup>°F</sup></li>
                                                        </ul>
                                                    </li>
                                                    <li class="wiDay">
                                                        <span>Thursday</span>
                                                        <ul class="wiForecast">
                                                            <li class="wi wi502"></li>
                                                            <li class="wiMax">55<sup>°F</sup></li>
                                                            <li class="wiMin">53<sup>°F</sup></li>
                                                        </ul>
                                                    </li>
                                                    <li class="wiDay"><span>Friday</span><ul class="wiForecast"><li class="wi wi800"></li><li class="wiMax">56<sup>°F</sup></li><li class="wiMin">51<sup>°F</sup></li></ul></li>
                                                </ul>
                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="panel panel-default">
                                    <div class="panel-heading">Panel heading without title</div>
                                    <div class="panel-body">
                                        Basic panel example
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="panel panel-default">
                                    <div class="panel-heading">Panel heading without title</div>
                                    <div class="panel-body">
                                        Basic panel example
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane" id="settings">
                        <div id="example"></div>

                        <div ng-repeat="i in items">
                            <button class="btn btn-lg btn-default" ng-style="{margin: '5px', width: '150px'}" ng-click="color(i)">
                                <div ng-style="{ background:i.color, width:'16px',height:'16px', margin:'auto',display:'inline-block'}" ng-show="i.color"></div>
                                <span ng-show="!i.color">{{i.title}}</span>
                            </button>
                        </div>


                    </div>
                    <div class="tab-pane" id="music">
                        Access music player

                    </div>
                    <div class="tab-pane" id="messages">

                        <div ng-repeat="msg in messages">
                            {{msg.Timestamp | date:'yyyy-MM-dd HH:mm:ss'}}: {{msg.AuthorId}}: {{msg.Text}}
                        </div>

                        Name:<input type="text" id="displayname" />
                        Message: <input type="text" id="message" />
                        <input type="button" id="sendmessage" value="Send" />

                        <input type="button" id="btnTV" value="TV on/off" ng-click="clickTV()" />
                        <ul id="discussion"></ul>


                    </div>

                    <div class="tab-pane" id="shopList">

                        <div ng-repeat="item in shoppingList">
                            {{item.Timestamp | date:'yyyy-MM-dd HH:mm:ss'}}: <input type="checkbox" ng-model="item.IsUrgent" ng-change="listHub.server.setUrgent(item.Id, item.IsUrgent)" /><input type="text" ng-model="item.Text" ng-change="item.uiDirty=true" /> <input type="button" value="Update" ng-click="listHub.server.updateText(item.Id, item.Text)" ng-show="item.uiDirty" /> {{item.IsBeingEditedBy.join(" , ")}}
                        </div>

                        New item: <input type="text" ng-model="newShoppingListItem.Text" />
                        <input type="button" value="Add" ng-click="addShopListItem()" />

                        <br />{{counter}}
                    </div>

                    <div class="tab-pane active" id="lights" ng-init="veraRefreshDevices();">

                        <!--<div ng-repeat="device in devices"-->
                        Set temperature (F): <input type="number" min="10" max="85" ng-model="temperatureF" /> <input type="button" ng-click="setTemperature(temperatureF)" />

                        <!--<br/>Kitchen
                        <input type="button" value="ON" ng-click="veraSend('data_request?id=action&output_format=xml&DeviceNum=3&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=1')" />
                        <input type="button" value="OFF" ng-click="veraSend('data_request?id=action&output_format=xml&DeviceNum=3&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=0')" />

                        <br />12 V Spotlights
                        <input type="button" value="ON" ng-click="veraSend('data_request?id=action&output_format=xml&DeviceNum=18&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=1')" />
                        <input type="button" value="OFF" ng-click="veraSend('data_request?id=action&output_format=xml&DeviceNum=18&serviceId=urn:upnp-org:serviceId:SwitchPower1&action=SetTarget&newTargetValue=0')" />-->



                        <div ng-repeat="device in devices track by device.id">
                            <div ng-if="device.category == 2 || device.category ==3" class="row">
                                <!-- Dimmable Switch=2; On/Off Switch=3 -->
                                <!--{{device.name}} ID:{{device.id}} Status: {{device.status}}-->
                                <!--<in
                                put type="button" value="ON" ng-click="veraSwitch(device.id, 1)" />
                                <input type="button" value="OFF" ng-click="veraSwitch(device.id, 0)" />-->

                                <div cl

                                <div class="col-xs-10">
                                    <button class="form-control btn btn-lg btn-default" style="text-align:left" ng-click="veraSwitch(device.id, 0==device.status)">
                                        <div ng-show="device.status" ng-style="{ background:'#ccc', border: '1px solid #888', width:'16px',height:'16px', margin:'auto',display:'inline-block'}"></div>
                                        <div ng-hide="device.status" ng-style="{ background:'transparent', border: '1px solid #888', width:'16px',height:'16px', margin:'auto',display:'inline-block'}"></div>
                                        <span>{{device.name}}</span>
                                    </button>
                                </div>
                                <div class="col-xs-1 hidden-xs">
                                    <button class="form-control btn btn-lg btn-default" style="text-align:left; background:#ccc" ng-click="veraSwitch(device.id, 1)">
                                        &nbsp;
                                    </button>
                                </div>
                                <div class="col-xs-1 hidden-xs">
                                    <button class="form-control btn btn-lg btn-default" style="text-align:left" ng-click="veraSwitch(device.id, 0)">
                                        &nbsp;
                                    </button>
                                </div>
                            </div>
                        </div>

                        <span>{{veraSendMessage}}</span>
                    </div>
                </div>

            </div>
        </div>

    </div>
    </div>

    <script type="text/javascript">
        var chat;
        $(function () {

        });



    </script>


    <script type="text/javascript">
        $(document).ready(function () {
            $('.side-menu a').click(function (e) {
                e.preventDefault()
                $(this).tab('show')
            });


            //Setup the plugin, see readme for more examples
            var example = $("#example").flatWeatherPlugin({
                location: "Boston, MA", //city and region *required 
                country: "USA",         //country *required 
                //optional:
                api: "openweathermap", //default: openweathermap (openweathermap or yahoo)
                //apikey: "your-api-key",   //optional api key for openweather
                view: "partial", //default: full (partial, full, simple, today or forecast)
                displayCityNameOnly: true, //default: false (true/false) if you want to display only city name
                forecast: 4, //default: 5 (0 -5) how many days you want forecast
                render: true, //default: true (true/false) if you want plugin to generate markup
                loadingAnimation: true //default: true (true/false) if you want plugin to show loading animation
                //units : "metric" or "imperial" default: "auto"
            });
        });
    </script>
</body>
</html>
